# ==============================================================================
# NAV2 CONFIG - REGULATED PURE PURSUIT - MECANUM ROBOT
# Tự động giảm tốc khi cua, tăng tốc khi đi thẳng
# ==============================================================================

# ------------------------------------------------------------------------------
# MAP SERVER - Quản lý bản đồ tĩnh
# ------------------------------------------------------------------------------
map_server:
  ros__parameters:
    use_sim_time: false
    yaml_filename: /home/dcd/mecanum_robot_ws/src/mecanum_robot_bringup/maps/ha10_tang8.yaml

# ------------------------------------------------------------------------------
# BT NAVIGATOR - Điều phối Behavior Tree
# ------------------------------------------------------------------------------
bt_navigator:
  ros__parameters:
    use_sim_time: false
    global_frame: map
    robot_base_frame: base_link
    odom_topic: /odometry/filtered
    bt_loop_duration: 10
    default_server_timeout: 20
    transform_tolerance: 0.2
    # Behavior tree mặc định
    default_nav_to_pose_bt_xml: "/opt/ros/humble/share/nav2_bt_navigator/behavior_trees/navigate_to_pose_w_replanning_and_recovery.xml"

# ------------------------------------------------------------------------------
# CONTROLLER SERVER - Regulated Pure Pursuit Controller
# ------------------------------------------------------------------------------
controller_server:
  ros__parameters:
    use_sim_time: false
    controller_frequency: 20.0  # 20Hz = 50ms/lần tính toán
    odom_topic: /odometry/filtered

    # === NGƯỠNG VẬN TỐC TỐI THIỂU ===
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001

    # === PLUGINS ===
    controller_plugins: ["FollowPath"]
    goal_checker_plugins: ["goal_checker"]
    progress_checker_plugin: "progress_checker"

    # === PROGRESS CHECKER - Nới lỏng để cho phép giảm tốc ===
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.10    # Di chuyển tối thiểu 10cm
      movement_time_allowance: 10.0     # 10s (tăng từ 5s vì robot chậm khi cua)

    # === GOAL CHECKER ===
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.15           # Sai số vị trí 15cm
      yaw_goal_tolerance: 0.25          # Sai số góc ~14°
      stateful: true

    # === REGULATED PURE PURSUIT CONTROLLER ===
    FollowPath:
      plugin: "nav2_regulated_pure_pursuit_controller::RegulatedPurePursuitController"

      # ========== VẬN TỐC CƠ BẢN ==========
      desired_linear_vel: 0.24          # Tốc độ mong muốn đoạn thẳng (m/s) - MAX của xe
      max_linear_accel: 0.4             # Gia tốc tối đa (m/s²)
      max_linear_decel: -0.8            # Giảm tốc tối đa (m/s²) - âm = phanh mạnh
      
      max_angular_accel: 1.0            # Gia tốc góc tối đa (rad/s²)
      max_robot_pose_search_dist: 3.0   # Tìm vị trí robot trên path trong 3m

      # ========== TỰ ĐỘNG GIẢM TỐC KHI CUA (QUAN TRỌNG!) ==========
      use_regulated_linear_velocity_scaling: true  # ⭐ BẬT điều chỉnh tốc độ theo độ cong
      
      regulated_linear_scaling_min_radius: 0.5     # Bán kính cua bắt đầu giảm tốc (m)
      # Nếu bán kính cua < 0.5m → bắt đầu giảm tốc
      
      regulated_linear_scaling_min_speed: 0.08     # Tốc độ tối thiểu khi cua gấp (m/s)
      # Cua gấp nhất (bán kính → 0) → tốc độ = 0.08 m/s (~33% max)
      
      # ========== GIẢM TỐC KHI GẦN VẬT CẢN ==========
      use_cost_regulated_linear_velocity_scaling: true  # ⭐ BẬT giảm tốc khi gần vật cản
      
      cost_scaling_dist: 0.6            # Bắt đầu giảm tốc khi cách vật cản < 60cm
      cost_scaling_gain: 1.0            # Hệ số giảm (1.0 = mạnh, 0.5 = nhẹ)
      inflation_cost_scaling_factor: 3.0 # Độ nhạy với inflation layer

      # ========== LOOKAHEAD DISTANCE - Nhìn trước path ==========
      lookahead_dist: 0.4               # Khoảng cách nhìn trước mặc định (m)
      min_lookahead_dist: 0.2           # Tối thiểu 20cm (cua gấp)
      max_lookahead_dist: 0.8           # Tối đa 80cm (đường thẳng)
      lookahead_time: 1.5               # Thời gian nhìn trước (giây)
      
      use_velocity_scaled_lookahead_dist: true  # ⭐ Lookahead tăng khi tốc độ cao
      # Tốc độ cao → nhìn xa hơn để dự đoán
      # Tốc độ thấp → nhìn gần hơn để bám sát

      # ========== ROTATION PARAMETERS - Xoay về path ==========
      rotate_to_heading_angular_vel: 0.3      # Tốc độ quay khi cần align (rad/s) - MAX của xe
      rotate_to_heading_min_angle: 0.785      # Góc tối thiểu để kích hoạt quay (45°)
      max_angular_vel: 0.3                    # Tốc độ góc tối đa (rad/s) - MAX của xe
      
      use_rotate_to_heading: true             # ⭐ BẬT xoay về heading trước khi đi
      # Robot sẽ quay về đúng hướng path trước khi tiến

      # ========== APPROACH VELOCITY - Tốc độ khi gần đích ==========
      min_approach_linear_velocity: 0.05      # Tốc độ tối thiểu khi gần đích (m/s)
      approach_velocity_scaling_dist: 1.0     # Bắt đầu giảm tốc khi cách đích < 1m
      use_approach_vel_scaling: true          # ⭐ BẬT giảm tốc khi gần đích

      # ========== PATH PARAMETERS ==========
      max_allowed_time_to_collision_up_to_carrot: 1.0  # Thời gian va chạm cho phép (s)
      use_collision_detection: true           # ⭐ BẬT phát hiện va chạm
      
      transform_tolerance: 0.2                # Sai số TF cho phép (giây)
      allow_reversing: false                  # Không cho phép lùi

# ------------------------------------------------------------------------------
# VELOCITY SMOOTHER - Làm mượt vận tốc (bổ trợ cho RPP)
# ------------------------------------------------------------------------------
velocity_smoother:
  ros__parameters:
    use_sim_time: false
    smoothing_frequency: 20.0         # 20Hz - đồng bộ với controller
    scale_velocities: true            # ⭐ Tự động scale vận tốc
    feedback: "OPEN_LOOP"             # Không dùng feedback odometry

    # === VẬN TỐC TỐI ĐA ===
    max_velocity: [0.24, 0.24, 0.3]   # [vx, vy, wz] m/s hoặc rad/s - THEO GIỚI HẠN XE
    min_velocity: [-0.24, -0.24, -0.3]

    # === GIA TỐC ===
    max_accel: [0.4, 0.4, 1.0]        # Tăng tốc [ax, ay, alpha]
    max_decel: [-0.8, -0.8, -1.5]     # Giảm tốc (âm)

    # === DEADBAND - Ngưỡng dừng ===
    deadband_velocity: [0.0, 0.0, 0.0]
    velocity_timeout: 1.0             # Timeout 1s nếu không nhận cmd_vel

    odom_topic: /odometry/filtered
    odom_duration: 0.1                # Lưu odometry 100ms

# ------------------------------------------------------------------------------
# PLANNER SERVER - Lập kế hoạch đường đi toàn cục
# ------------------------------------------------------------------------------
planner_server:
  ros__parameters:
    use_sim_time: false
    expected_planner_frequency: 20.0  # 20Hz - tính path nhanh
    planner_plugins: ["GridBased"]

    GridBased:
      plugin: "nav2_navfn_planner/NavfnPlanner"  # NavFn = Dijkstra/A*
      tolerance: 0.2                             # Sai số đích 20cm
      use_astar: true                            # Dùng A* (nhanh hơn Dijkstra)
      allow_unknown: true                        # Cho phép đi qua vùng chưa biết
      use_final_approach_orientation: false      # Không ép hướng cuối

# ------------------------------------------------------------------------------
# SMOOTHER SERVER - Làm mượt path toàn cục
# ------------------------------------------------------------------------------
smoother_server:
  ros__parameters:
    use_sim_time: false
    smoother_plugins: ["simple_smoother"]

    simple_smoother:
      plugin: "nav2_smoother::SimpleSmoother"
      tolerance: 1.0e-10                # Sai số hội tụ rất nhỏ
      max_its: 1000                     # Tối đa 1000 vòng lặp
      do_refinement: true               # Làm mịn thêm sau khi hội tụ
      refinement_num: 2                 # Số lần làm mịn

# ------------------------------------------------------------------------------
# BEHAVIOR SERVER - Các hành vi phục hồi
# ------------------------------------------------------------------------------
behavior_server:
  ros__parameters:
    use_sim_time: false
    global_frame: map
    robot_base_frame: base_link
    transform_tolerance: 0.1
    simulate_ahead_time: 2.0          # Mô phỏng behavior 2s về tương lai

    behavior_plugins: ["spin", "backup", "drive_on_heading", "wait"]

    # === SPIN - Quay tại chỗ ===
    spin:
      plugin: "nav2_behaviors/Spin"
      simulate_ahead_time: 2.0
      max_rotational_vel: 0.3         # Quay tối đa 0.3 rad/s - MAX của xe
      min_rotational_vel: 0.2         # Quay tối thiểu 0.2 rad/s
      rotational_acc_lim: 0.8         # Gia tốc quay 0.8 rad/s²

    # === BACKUP - Lùi lại ===
    backup:
      plugin: "nav2_behaviors/BackUp"
      simulate_ahead_time: 2.0
      backup_dist: 0.3                # Lùi 30cm
      backup_speed: 0.15              # Tốc độ lùi 0.15 m/s (~60% max)
      time_allowance: 10.0            # Cho phép 10s để lùi

    # === DRIVE ON HEADING - Đi thẳng một hướng ===
    drive_on_heading:
      plugin: "nav2_behaviors/DriveOnHeading"
      simulate_ahead_time: 2.0
      max_linear_vel: 0.24            # MAX của xe
      min_linear_vel: 0.08
      max_angular_vel: 0.3            # MAX của xe
      time_allowance: 10.0

    # === WAIT - Chờ ===
    wait:
      plugin: "nav2_behaviors/Wait"
      simulate_ahead_time: 2.0
      wait_duration: 5                # Đợi 5 giây

# ------------------------------------------------------------------------------
# LOCAL COSTMAP - Bản đồ chi phí cục bộ
# ------------------------------------------------------------------------------
local_costmap:
  local_costmap:
    ros__parameters:
      use_sim_time: false
      global_frame: odom              # Frame odometry (di động)
      robot_base_frame: base_link
      rolling_window: true            # Costmap di chuyển theo robot

      update_frequency: 5.0           # Cập nhật 5Hz
      publish_frequency: 2.0          # Publish 2Hz

      width: 4                        # 4m × 4m quanh robot
      height: 4
      resolution: 0.05                # 5cm/cell

      # === FOOTPRINT - Hình dạng robot ===
      footprint: "[[-0.425,-0.30],[0.425,-0.30],[0.425,0.30],[-0.425,0.30]]"
      footprint_padding: 0.02

      # === PLUGINS ===
      plugins: ["obstacle_layer", "inflation_layer"]

      # --- OBSTACLE LAYER ---
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: true
        observation_sources: scan
        
        scan:
          topic: /scan_merged
          data_type: "LaserScan"
          clearing: true              # Xóa vật cản khi không thấy
          marking: true               # Đánh dấu vật cản
          obstacle_max_range: 3.0     # Phát hiện tối đa 3m
          raytrace_max_range: 6.0     # Xóa tối đa 6m
          min_obstacle_height: 0.0
          max_obstacle_height: 2.0

      # --- INFLATION LAYER ---
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        enabled: true
        inflation_radius: 0.6         # Phồng 60cm (nhỏ để bám path tốt)
        cost_scaling_factor: 3.0      # Hệ số giảm chi phí

# ------------------------------------------------------------------------------
# GLOBAL COSTMAP - Bản đồ chi phí toàn cục
# ------------------------------------------------------------------------------
global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: false
      global_frame: map               # Frame bản đồ (cố định)
      robot_base_frame: base_link
      rolling_window: false           # Costmap cố định

      update_frequency: 1.0           # Cập nhật 1Hz (chậm hơn local)
      publish_frequency: 1.0

      resolution: 0.05                # 5cm/cell
      track_unknown_space: true       # Theo dõi vùng chưa biết

      # === FOOTPRINT ===
      footprint: "[[-0.425,-0.30],[0.425,-0.30],[0.425,0.30],[-0.425,0.30]]"
      footprint_padding: 0.02

      # === PLUGINS ===
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]

      # --- STATIC LAYER ---
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        enabled: true
        map_subscribe_transient_local: true

      # --- OBSTACLE LAYER ---
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: true
        observation_sources: scan
        
        scan:
          topic: /scan_merged
          data_type: "LaserScan"
          clearing: true
          marking: true
          obstacle_max_range: 3.0
          raytrace_max_range: 6.0

      # --- INFLATION LAYER ---
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        enabled: true
        inflation_radius: 0.6
        cost_scaling_factor: 3.0

# ------------------------------------------------------------------------------
# AMCL - Định vị Monte Carlo
# ------------------------------------------------------------------------------
amcl:
  ros__parameters:
    use_sim_time: false
    
    # === FRAMES ===
    global_frame_id: map
    odom_frame_id: odom
    base_frame_id: base_link
    
    # === TOPICS ===
    scan_topic: /scan_merged
    
    # === TF ===
    tf_broadcast: true
    transform_tolerance: 0.2
    
    # === PARTICLES ===
    min_particles: 500              # Tối thiểu 500 particles
    max_particles: 2000             # Tối đa 2000 particles
    
    # === UPDATE THRESHOLDS ===
    update_min_d: 0.05              # Cập nhật khi di chuyển > 5cm
    update_min_a: 0.05              # Cập nhật khi quay > 0.05 rad (~3°)
    
    # === FILTER ===
    resample_interval: 2            # Resample mỗi 2 lần update
    recovery_alpha_slow: 0.0        # Tắt recovery (dùng behavior thay thế)
    recovery_alpha_fast: 0.0
    
    # === INITIAL POSE ===
    set_initial_pose: true          # Đặt pose ban đầu
    initial_pose:
      x: 0.0
      y: 0.0
      z: 0.0
      yaw: 0.0

# ------------------------------------------------------------------------------
# LIFECYCLE MANAGER - Quản lý vòng đời các node
# ------------------------------------------------------------------------------
lifecycle_manager:
  ros__parameters:
    use_sim_time: false
    autostart: true                 # Tự động khởi động
    node_names: [
      "controller_server",
      "planner_server",
      "behavior_server",
      "bt_navigator",
      "smoother_server",
      "velocity_smoother",
      "amcl",
      "map_server"
    ]
    bond_timeout: 4.0               # Timeout bond 4s